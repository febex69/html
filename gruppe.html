<script>
function generateGroups() {
  const mode = modeSelect.value;
  const active = getActiveNames();
  if (active.length === 0) return alert("Select at least one name!");

  let groups = [];
  const shuffled = shuffle([...active]);

  if (mode === "groupCount") {
    const count = parseInt(document.getElementById("groupCountInput").value);
    groups = Array.from({ length: count }, () => []);
    shuffled.forEach((name, i) => groups[i % count].push(name));
  }
  else if (mode === "groupSize") {
    const size = parseInt(document.getElementById("groupSizeInput").value);
    const groupCount = Math.ceil(shuffled.length / size); // avoid last group being too big
    groups = Array.from({ length: groupCount }, () => []);
    shuffled.forEach((name, i) => groups[i % groupCount].push(name));
  }
  else if (mode === "customPattern") {
    let patternText = document.getElementById("patternInput").value || document.getElementById("presetSelect").value;
    let pattern = patternText.split(',').map(n => parseInt(n.trim()));
    
    const totalPattern = pattern.reduce((a,b)=>a+b,0);
    if (totalPattern < shuffled.length) {
      // evenly distribute remaining people
      let extra = shuffled.length - totalPattern;
      let i = 0;
      while(extra > 0){
        pattern[i % pattern.length]++;
        i++;
        extra--;
      }
    }

    let idx = 0;
    pattern.forEach(size => {
      groups.push(shuffled.slice(idx, idx + size));
      idx += size;
    });
  }

  renderGroups(groups);
}

function renderGroups(groups) {
  const container = document.getElementById("groups");
  container.innerHTML = "";

  groups.forEach((group, i) => {
    const div = document.createElement("div");
    div.className = "group";
    const title = document.createElement("h2");
    title.textContent = "Group " + (i + 1);

    const ul = document.createElement("ul");
    group.forEach(n => {
      const li = document.createElement("li");
      li.textContent = n;
      li.draggable = true;

      li.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", e.target.textContent);
        e.target.classList.add("dragging");
      });
      li.addEventListener("dragend", e => {
        e.target.classList.remove("dragging");
      });
      li.addEventListener("dragover", e => e.preventDefault());
      li.addEventListener("drop", e => {
        e.preventDefault();
        const draggedName = e.dataTransfer.getData("text/plain");
        const targetName = e.target.textContent;

        // swap names
        e.target.textContent = draggedName;
        const draggingEl = container.querySelector(".dragging");
        if(draggingEl) draggingEl.textContent = targetName;
        draggingEl.classList.remove("dragging");
      });

      ul.appendChild(li);
    });

    div.appendChild(title);
    div.appendChild(ul);
    container.appendChild(div);
  });
}
</script>
